exports.id=623,exports.ids=[623],exports.modules={156:(e,t,n)=>{"use strict";n.d(t,{Y:()=>s});var r=n(2985),o=n(4795);function s(e,t={}){let{autoConnect:n=!0,onMessage:a,onError:i,onStatusChange:c}=t,l=(0,r.useRef)(null),[u,d]=(0,r.useState)([]),[h,p]=(0,r.useState)("connecting"),f=(0,r.useRef)(null),m=(0,r.useRef)(!0),b=(0,r.useCallback)(e=>{p(e),c?.(e)},[c]),y=(0,r.useCallback)(e=>{let t;try{t=JSON.parse(e.data)}catch(t){console.error("WebSocket message parse error:",e.data,t);return}let n=t.data||{};switch(t.event){case"thinking":g();break;case"chunk":k(n);break;case"response":w(n);break;case"conversationReset":N();break;case"toolCall":x(n);break;case"toolResult":S(n);break;case"error":P(n);break;case"connected":console.log("WebSocket connection confirmed by backend");break;case"connectionUpdated":console.log("WebSocket connection updated:",n);break;default:console.warn("Unknown WebSocket event:",t.event)}},[]),g=(0,r.useCallback)(()=>{m.current&&d(e=>e.some(e=>"system"===e.role&&"Cipher is thinking..."===e.content)?e:[...e,{id:(0,o.Ij)(),role:"system",content:"Cipher is thinking...",createdAt:Date.now()}])},[]),C=(0,r.useRef)(new Set),v=(0,r.useRef)(null),k=(0,r.useCallback)(e=>{if(!m.current)return;let t="string"==typeof e.text?e.text:"",n=e.messageId||"";if(!t)return;let r=`${n}-${t}`;if(C.current.has(r))return void console.warn("Skipping duplicate chunk:",t.slice(0,50)+"...");C.current.add(r),d(e=>{let r=e.filter(e=>"system"!==e.role||"Cipher is thinking..."!==e.content),s=r[r.length-1];if(s&&"assistant"===s.role&&"string"==typeof s.content){if(null===v.current&&(v.current=s.id),n&&s.id!==n)return v.current=n,[...r,{id:n||(0,o.Ij)(),role:"assistant",content:t,createdAt:Date.now()}];let e=s.content+t,a={...s,content:e,createdAt:Date.now()};return[...r.slice(0,-1),a]}let a=n||(0,o.Ij)();return v.current=a,[...r,{id:a,role:"assistant",content:t,createdAt:Date.now()}]})},[]),w=(0,r.useCallback)(e=>{if(!m.current)return;let t="string"==typeof e.text?e.text:"",n="number"==typeof e.tokenCount?e.tokenCount:void 0,r="string"==typeof e.model?e.model:void 0,s="string"==typeof e.sessionId?e.sessionId:void 0;d(e=>{let a=e.filter(e=>"system"!==e.role||"Cipher is thinking..."!==e.content),i=t;if(f.current){let e=f.current,[,n]=e.split(","),r=e.match(/data:(.*);base64/),o={type:"image",base64:n,mimeType:r?r[1]:"image/png"};i=t.trim()?[{type:"text",text:t},o]:[o]}let c={id:(0,o.Ij)(),role:"assistant",content:i,createdAt:Date.now(),tokenCount:n,model:r,sessionId:s},l=a[a.length-1];if(l&&"assistant"===l.role){if(l.content&&"string"==typeof l.content&&l.content.trim()){let e={...l,tokenCount:n,model:r,sessionId:s,createdAt:Date.now()};return[...a.slice(0,-1),e]}return[...a.slice(0,-1),c]}return[...a,c]}),(0,o.$K)("cipher:response",{text:t,sessionId:s,tokenCount:n,model:r,timestamp:Date.now()}),f.current=null,v.current=null,a&&a({id:(0,o.Ij)(),role:"assistant",content:t,createdAt:Date.now(),tokenCount:n,model:r,sessionId:s})},[a]),x=(0,r.useCallback)(e=>{if(!m.current)return;let t=e.toolName,n=e.args,r={id:(0,o.Ij)(),role:"tool",content:null,toolName:t,toolArgs:n,createdAt:Date.now()};d(e=>[...e,r])},[]),S=(0,r.useCallback)(e=>{if(!m.current)return;let t=e.toolName,n=e.result;f.current=n?(0,o.EV)(n):null,d(e=>{let r=e.findIndex(e=>"tool"===e.role&&e.toolName===t&&void 0===e.toolResult);if(-1!==r){let t={...e[r],toolResult:n};return[...e.slice(0,r),t,...e.slice(r+1)]}return console.warn(`No matching tool call found for result of ${t}`),e})},[]),N=(0,r.useCallback)(()=>{m.current&&(d([]),C.current.clear(),v.current=null)},[]),P=(0,r.useCallback)(e=>{if(!m.current)return;let t=e.message??"Unknown error",n="string"==typeof t?t:JSON.stringify(t,null,2),r={id:(0,o.Ij)(),role:"system",content:n,createdAt:Date.now()};d(e=>[...e,r]),i?.(n)},[i]),j=(0,r.useCallback)(()=>{if(l.current?.readyState!==WebSocket.OPEN&&l.current?.readyState!==WebSocket.CONNECTING){l.current&&(l.current.close(),l.current=null);try{console.log("Creating WebSocket connection to:",e);let t=new WebSocket(e);l.current=t,t.onopen=()=>{console.log("WebSocket connected successfully"),b("open")},t.onclose=e=>{console.log("WebSocket disconnected",e.code,e.reason),b("closed"),1e3!==e.code&&m.current&&n&&setTimeout(()=>{m.current&&l.current?.readyState!==WebSocket.OPEN&&(console.log("Attempting to reconnect..."),j())},3e3)},t.onerror=e=>{console.error("WebSocket error:",e),i?.("WebSocket connection error")},t.onmessage=y,b("connecting")}catch(e){console.error("Failed to create WebSocket connection:",e),b("closed"),i?.("Failed to establish WebSocket connection")}}},[e,n,b,y,i]),I=(0,r.useCallback)(()=>{l.current&&(l.current.close(1e3,"Intentional disconnect"),l.current=null)},[]),E=(0,r.useCallback)((e,t,n,r,s=!0)=>{if(l.current?.readyState===WebSocket.OPEN)try{l.current.send(JSON.stringify({type:"message",content:e,imageData:t,fileData:n,sessionId:r,stream:s}));let i={id:(0,o.Ij)(),role:"user",content:e,createdAt:Date.now(),sessionId:r,imageData:t,fileData:n};d(e=>[...e,i]),(0,o.$K)("cipher:message",{content:e,sessionId:r,timestamp:Date.now()}),a?.(i)}catch(e){console.error("Failed to send message:",e),i?.("Failed to send message")}else console.warn("WebSocket is not connected. Cannot send message."),i?.("Not connected to chat service")},[a,i]);return{messages:u,status:h,isConnected:"open"===h,isConnecting:"connecting"===h,sendMessage:E,reset:(0,r.useCallback)(e=>{if(l.current?.readyState===WebSocket.OPEN)try{l.current.send(JSON.stringify({type:"reset",sessionId:e}))}catch(e){console.error("Failed to send reset message:",e),i?.("Failed to reset conversation")}d([])},[i]),clearMessages:(0,r.useCallback)(()=>{d([]),C.current.clear(),v.current=null},[]),connect:j,disconnect:I,setMessages:d,websocket:l.current}}},676:(e,t,n)=>{Promise.resolve().then(n.bind(n,3239))},1144:(e,t,n)=>{"use strict";n.d(t,{ChatProvider:()=>c,vd:()=>l});var r=n(3672),o=n(2985),s=n(156),a=n(7834);let i=(0,o.createContext)(null);function c({children:e,wsUrl:t,autoConnect:n=!0}){let c=(0,a.$0)(t),[l,u]=(0,o.useState)(null),[d,h]=(0,o.useState)(!0),[p,f]=(0,o.useState)(!0),{messages:m,sendMessage:b,status:y,reset:g,setMessages:C,websocket:v,clearMessages:k}=(0,s.Y)(c,{autoConnect:n,onMessage:e=>{},onError:e=>{console.error("Chat WebSocket error:",e)},onStatusChange:e=>{console.log("Chat WebSocket status changed:",e)}}),w=(0,o.useCallback)(async(e,t,n)=>{let r=l;if(!r&&d)try{r=await (0,a.Kd)(),await (0,a.L6)(r),u(r),h(!1)}catch(e){throw console.error("Error creating auto session:",e),e}if(r)b(e,t,n,r,p);else throw console.error("No session available for sending message"),Error("No session available for sending message")},[b,l,d,p]),x=(0,o.useCallback)(async e=>{try{let t=await (0,a.Vy)(e),n=(0,a.F1)(t,e);C(n)}catch(e){console.error("Error loading session history:",e),C([])}},[C]),S=(0,o.useCallback)(async e=>{if(e!==l)try{await (0,a.L6)(e),u(e),h(!1),await x(e)}catch(e){throw console.error("Error switching session:",e),e}},[l,x]),N=(0,o.useCallback)(()=>{u(null),h(!0),k(),(0,a.wb)()},[l,k]),P=(0,o.useCallback)(()=>{l&&g(l)},[g,l]),j=(0,o.useCallback)(e=>{f(e)},[l]);return(0,o.useCallback)(async()=>{try{let e=await (0,a.Kd)();return await (0,a.L6)(e),e}catch(e){throw console.error("Error creating new session:",e),e}},[]),(0,r.jsx)(i.Provider,{value:{messages:m,sendMessage:w,status:y,reset:P,currentSessionId:l,switchSession:S,loadSessionHistory:x,isWelcomeState:d,returnToWelcome:N,isStreaming:p,setStreaming:j,websocket:v},children:e})}function l(){let e=(0,o.useContext)(i);if(!e)throw Error("useChatContext must be used within a ChatProvider");return e}},1720:()=>{},2445:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>o});var r=n(3672);function o({error:e,reset:t}){return(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center space-y-6 max-w-md",children:[(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold text-destructive",children:"Something went wrong!"}),(0,r.jsx)("p",{className:"text-muted-foreground",children:"An error occurred while loading the application."})]}),(0,r.jsx)("div",{className:"bg-destructive/10 border border-destructive/20 rounded-lg p-4",children:(0,r.jsx)("p",{className:"text-sm text-destructive font-mono",children:e.message||"Unknown error occurred"})}),(0,r.jsx)("button",{onClick:t,className:"bg-primary hover:bg-primary/90 text-primary-foreground px-4 py-2 rounded-lg transition-colors",children:"Try again"})]})})}n(2985)},3239:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>r});let r=(0,n(4994).registerClientReference)(function(){throw Error("Attempted to call the default export of \"/Users/nguyenduyanh/Myspace/campfire/cipher/src/app/ui/src/app/error.tsx\" from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/Users/nguyenduyanh/Myspace/campfire/cipher/src/app/ui/src/app/error.tsx","default")},3756:()=>{},3815:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>a,metadata:()=>s});var r=n(8642);n(1720);var o=n(4250);let s={title:"Cipher UI",description:"Interactive web interface for the Cipher AI agent framework"};function a({children:e}){return(0,r.jsx)("html",{lang:"en",children:(0,r.jsx)("body",{className:"antialiased bg-background text-foreground",children:(0,r.jsx)(o.ChatProvider,{children:(0,r.jsx)("div",{className:"flex h-screen w-screen flex-col",children:e})})})})}},3828:(e,t,n)=>{Promise.resolve().then(n.bind(n,2445))},4185:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>o});var r=n(8642);function o(){return(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center space-y-4",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"}),(0,r.jsx)("p",{className:"text-muted-foreground",children:"Loading Cipher UI..."})]})})}},4250:(e,t,n)=>{"use strict";n.d(t,{ChatProvider:()=>o});var r=n(4994);let o=(0,r.registerClientReference)(function(){throw Error("Attempted to call ChatProvider() from the server but ChatProvider is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/Users/nguyenduyanh/Myspace/campfire/cipher/src/app/ui/src/contexts/chat-context.tsx","ChatProvider");(0,r.registerClientReference)(function(){throw Error("Attempted to call useChatContext() from the server but useChatContext is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/Users/nguyenduyanh/Myspace/campfire/cipher/src/app/ui/src/contexts/chat-context.tsx","useChatContext"),(0,r.registerClientReference)(function(){throw Error("Attempted to call useChatSession() from the server but useChatSession is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/Users/nguyenduyanh/Myspace/campfire/cipher/src/app/ui/src/contexts/chat-context.tsx","useChatSession"),(0,r.registerClientReference)(function(){throw Error("Attempted to call useChatMessages() from the server but useChatMessages is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/Users/nguyenduyanh/Myspace/campfire/cipher/src/app/ui/src/contexts/chat-context.tsx","useChatMessages"),(0,r.registerClientReference)(function(){throw Error("Attempted to call useChatStatus() from the server but useChatStatus is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/Users/nguyenduyanh/Myspace/campfire/cipher/src/app/ui/src/contexts/chat-context.tsx","useChatStatus")},4308:(e,t,n)=>{Promise.resolve().then(n.bind(n,4250))},4795:(e,t,n)=>{"use strict";n.d(t,{$K:()=>s,EV:()=>o,Ij:()=>r,VR:()=>a});let r=()=>`msg-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;function o(e){var t;if("string"==typeof e&&e.startsWith("data:image"))return e;if("object"==typeof(t=e)&&null!==t&&"content"in t&&Array.isArray(t.content)){let t=e.content.find(e=>{var t;return"object"==typeof(t=e)&&null!==t&&"type"in t&&"image"===t.type&&"base64"in t&&"mimeType"in t&&"string"==typeof t.base64&&"string"==typeof t.mimeType||"image"===e.type});if(t)return`data:${t.mimeType};base64,${t.base64}`}if("object"==typeof e&&null!==e){if("data"in e&&"mimeType"in e)return`data:${e.mimeType};base64,${e.data}`;if("screenshot"in e&&"string"==typeof e.screenshot)return e.screenshot;if("image"in e&&"string"==typeof e.image)return e.image;if("url"in e&&"string"==typeof e.url&&e.url.startsWith("data:image"))return e.url}return null}function s(e,t){}function a(e){let t={...e,content:null===e.content?"":e.content};return Array.isArray(e.content)&&(t.content=e.content.map(e=>({type:e.type,text:e.text,base64:e.base64,mimeType:e.mimeType,data:e.data,filename:e.filename}))),t}},5675:(e,t,n)=>{Promise.resolve().then(n.t.bind(n,5503,23)),Promise.resolve().then(n.t.bind(n,4675,23)),Promise.resolve().then(n.t.bind(n,9703,23)),Promise.resolve().then(n.t.bind(n,3782,23)),Promise.resolve().then(n.t.bind(n,5298,23)),Promise.resolve().then(n.t.bind(n,9318,23)),Promise.resolve().then(n.t.bind(n,9764,23)),Promise.resolve().then(n.t.bind(n,8646,23))},7308:()=>{},7460:(e,t,n)=>{Promise.resolve().then(n.bind(n,1144))},7834:(e,t,n)=>{"use strict";function r(e){return e||process.env.NEXT_PUBLIC_WS_URL||"ws://localhost:3001/ws"}async function o(){try{let e=await fetch("/api/sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!e.ok)throw Error("Failed to create session");let t=await e.json();if(t.success&&t.data?.session?.id)return t.data.session.id;if(t.data?.sessionId)return t.data.sessionId;throw console.error("Unexpected session response format:",t),Error("Invalid session response format")}catch(e){return console.error("Error creating auto session:",e),`chat-${Date.now()}`}}async function s(e){if(!(await fetch(`/api/sessions/${e}/load`,{method:"POST",headers:{"Content-Type":"application/json"}})).ok)throw Error("Failed to load session on backend")}async function a(e){let t=await fetch(`/api/sessions/${e}/history`);if(!t.ok){if(404===t.status){if(!(await fetch("/api/sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e})})).ok)throw Error("Failed to create session");return[]}throw Error("Failed to load session history")}let n=await t.json();return n.data?.history||n.history||[]}function i(e,t){let n=[];for(let r=0;r<e.length;r++){let o=e[r],s={id:`session-${t}-${r}`,role:o.role,content:o.content,createdAt:Date.now()-(e.length-r)*1e3,sessionId:t};if("assistant"===o.role&&o.toolCalls&&o.toolCalls.length>0)o.content&&n.push(s),o.toolCalls.forEach((o,s)=>{let a,i=o.function?JSON.parse(o.function.arguments||"{}"):{},c=o.function?.name||"unknown";for(let t=r+1;t<e.length;t++){let n=e[t];if("tool"===n.role&&n.toolCallId===o.id){a=n.content;break}}n.push({id:`session-${t}-${r}-tool-${s}`,role:"tool",content:null,createdAt:Date.now()-(e.length-r)*1e3+s,sessionId:t,toolName:c,toolArgs:i,toolResult:a})});else{if("tool"===o.role)continue;n.push(s)}}return n}async function c(){try{await fetch("/api/sessions/null/load",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(e){console.warn("Error resetting backend session:",e)}}n.d(t,{$0:()=>r,F1:()=>i,Kd:()=>o,L6:()=>s,Vy:()=>a,wb:()=>c}),process.env.NEXT_PUBLIC_API_URL},8723:(e,t,n)=>{Promise.resolve().then(n.t.bind(n,9141,23)),Promise.resolve().then(n.t.bind(n,9637,23)),Promise.resolve().then(n.t.bind(n,8381,23)),Promise.resolve().then(n.t.bind(n,1100,23)),Promise.resolve().then(n.t.bind(n,7108,23)),Promise.resolve().then(n.t.bind(n,6952,23)),Promise.resolve().then(n.t.bind(n,8182,23)),Promise.resolve().then(n.t.bind(n,1648,23))}};