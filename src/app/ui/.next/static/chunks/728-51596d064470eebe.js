"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[728],{1879:(e,t,n)=>{n.d(t,{$K:()=>s,EV:()=>r,Ij:()=>o,VR:()=>a});let o=()=>"msg-".concat(Date.now(),"-").concat(Math.random().toString(36).substring(2,9));function r(e){var t;if("string"==typeof e&&e.startsWith("data:image"))return e;if("object"==typeof(t=e)&&null!==t&&"content"in t&&Array.isArray(t.content)){let t=e.content.find(e=>{var t;return"object"==typeof(t=e)&&null!==t&&"type"in t&&"image"===t.type&&"base64"in t&&"mimeType"in t&&"string"==typeof t.base64&&"string"==typeof t.mimeType||"image"===e.type});if(t)return"data:".concat(t.mimeType,";base64,").concat(t.base64)}if("object"==typeof e&&null!==e){if("data"in e&&"mimeType"in e)return"data:".concat(e.mimeType,";base64,").concat(e.data);if("screenshot"in e&&"string"==typeof e.screenshot)return e.screenshot;if("image"in e&&"string"==typeof e.image)return e.image;if("url"in e&&"string"==typeof e.url&&e.url.startsWith("data:image"))return e.url}return null}function s(e,t){window.dispatchEvent(new CustomEvent(e,{detail:t}))}function a(e){let t={...e,content:null===e.content?"":e.content};return Array.isArray(e.content)&&(t.content=e.content.map(e=>({type:e.type,text:e.text,base64:e.base64,mimeType:e.mimeType,data:e.data,filename:e.filename}))),t}},6036:(e,t,n)=>{n.d(t,{Y:()=>s});var o=n(4464),r=n(1879);function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{autoConnect:n=!0,onMessage:s,onError:a,onStatusChange:i}=t,c=(0,o.useRef)(null),[l,u]=(0,o.useState)([]),[d,h]=(0,o.useState)("connecting"),f=(0,o.useRef)(null),w=(0,o.useRef)(!0),p=(0,o.useCallback)(e=>{h(e),null==i||i(e)},[i]),g=(0,o.useCallback)(e=>{let t;try{t=JSON.parse(e.data)}catch(t){console.error("WebSocket message parse error:",e.data,t);return}let n=t.data||{};switch(t.event){case"thinking":m();break;case"chunk":b(n);break;case"response":k(n);break;case"conversationReset":S();break;case"toolCall":C(n);break;case"toolResult":E(n);break;case"error":I(n);break;case"connected":console.log("WebSocket connection confirmed by backend");break;case"connectionUpdated":console.log("WebSocket connection updated:",n);break;default:console.warn("Unknown WebSocket event:",t.event)}},[]),m=(0,o.useCallback)(()=>{w.current&&u(e=>e.some(e=>"system"===e.role&&"Cipher is thinking..."===e.content)?e:[...e,{id:(0,r.Ij)(),role:"system",content:"Cipher is thinking...",createdAt:Date.now()}])},[]),y=(0,o.useRef)(new Set),v=(0,o.useRef)(null),b=(0,o.useCallback)(e=>{if(!w.current)return;let t="string"==typeof e.text?e.text:"",n=e.messageId||"";if(!t)return;let o="".concat(n,"-").concat(t);if(y.current.has(o))return void console.warn("Skipping duplicate chunk:",t.slice(0,50)+"...");y.current.add(o),u(e=>{let o=e.filter(e=>"system"!==e.role||"Cipher is thinking..."!==e.content),s=o[o.length-1];if(s&&"assistant"===s.role&&"string"==typeof s.content){if(null===v.current&&(v.current=s.id),n&&s.id!==n)return v.current=n,[...o,{id:n||(0,r.Ij)(),role:"assistant",content:t,createdAt:Date.now()}];let e=s.content+t,a={...s,content:e,createdAt:Date.now()};return[...o.slice(0,-1),a]}let a=n||(0,r.Ij)();return v.current=a,[...o,{id:a,role:"assistant",content:t,createdAt:Date.now()}]})},[]),k=(0,o.useCallback)(e=>{if(!w.current)return;let t="string"==typeof e.text?e.text:"",n="number"==typeof e.tokenCount?e.tokenCount:void 0,o="string"==typeof e.model?e.model:void 0,a="string"==typeof e.sessionId?e.sessionId:void 0;u(e=>{let s=e.filter(e=>"system"!==e.role||"Cipher is thinking..."!==e.content),i=t;if(f.current){let e=f.current,[,n]=e.split(","),o=e.match(/data:(.*);base64/),r={type:"image",base64:n,mimeType:o?o[1]:"image/png"};i=t.trim()?[{type:"text",text:t},r]:[r]}let c={id:(0,r.Ij)(),role:"assistant",content:i,createdAt:Date.now(),tokenCount:n,model:o,sessionId:a},l=s[s.length-1];if(l&&"assistant"===l.role){if(l.content&&"string"==typeof l.content&&l.content.trim()){let e={...l,tokenCount:n,model:o,sessionId:a,createdAt:Date.now()};return[...s.slice(0,-1),e]}return[...s.slice(0,-1),c]}return[...s,c]}),(0,r.$K)("cipher:response",{text:t,sessionId:a,tokenCount:n,model:o,timestamp:Date.now()}),f.current=null,v.current=null,s&&s({id:(0,r.Ij)(),role:"assistant",content:t,createdAt:Date.now(),tokenCount:n,model:o,sessionId:a})},[s]),C=(0,o.useCallback)(e=>{if(!w.current)return;let t=e.toolName,n=e.args,o={id:(0,r.Ij)(),role:"tool",content:null,toolName:t,toolArgs:n,createdAt:Date.now()};u(e=>[...e,o])},[]),E=(0,o.useCallback)(e=>{if(!w.current)return;let t=e.toolName,n=e.result;f.current=n?(0,r.EV)(n):null,u(e=>{let o=e.findIndex(e=>"tool"===e.role&&e.toolName===t&&void 0===e.toolResult);if(-1!==o){let t={...e[o],toolResult:n};return[...e.slice(0,o),t,...e.slice(o+1)]}return console.warn("No matching tool call found for result of ".concat(t)),e})},[]),S=(0,o.useCallback)(()=>{w.current&&(u([]),y.current.clear(),v.current=null)},[]),I=(0,o.useCallback)(e=>{var t;if(!w.current)return;let n=null!=(t=e.message)?t:"Unknown error",o="string"==typeof n?n:JSON.stringify(n,null,2),s={id:(0,r.Ij)(),role:"system",content:o,createdAt:Date.now()};u(e=>[...e,s]),null==a||a(o)},[a]),N=(0,o.useCallback)(()=>{var t,o;if((null==(t=c.current)?void 0:t.readyState)!==WebSocket.OPEN&&(null==(o=c.current)?void 0:o.readyState)!==WebSocket.CONNECTING){c.current&&(c.current.close(),c.current=null);try{console.log("Creating WebSocket connection to:",e);let t=new WebSocket(e);c.current=t,t.onopen=()=>{console.log("WebSocket connected successfully"),p("open")},t.onclose=e=>{console.log("WebSocket disconnected",e.code,e.reason),p("closed"),1e3!==e.code&&w.current&&n&&setTimeout(()=>{var e;w.current&&(null==(e=c.current)?void 0:e.readyState)!==WebSocket.OPEN&&(console.log("Attempting to reconnect..."),N())},3e3)},t.onerror=e=>{console.error("WebSocket error:",e),null==a||a("WebSocket connection error")},t.onmessage=g,p("connecting")}catch(e){console.error("Failed to create WebSocket connection:",e),p("closed"),null==a||a("Failed to establish WebSocket connection")}}},[e,n,p,g,a]),W=(0,o.useCallback)(()=>{c.current&&(c.current.close(1e3,"Intentional disconnect"),c.current=null)},[]),T=(0,o.useCallback)(function(e,t,n,o){var i;let l=!(arguments.length>4)||void 0===arguments[4]||arguments[4];if((null==(i=c.current)?void 0:i.readyState)===WebSocket.OPEN)try{c.current.send(JSON.stringify({type:"message",content:e,imageData:t,fileData:n,sessionId:o,stream:l}));let a={id:(0,r.Ij)(),role:"user",content:e,createdAt:Date.now(),sessionId:o,imageData:t,fileData:n};u(e=>[...e,a]),(0,r.$K)("cipher:message",{content:e,sessionId:o,timestamp:Date.now()}),null==s||s(a)}catch(e){console.error("Failed to send message:",e),null==a||a("Failed to send message")}else console.warn("WebSocket is not connected. Cannot send message."),null==a||a("Not connected to chat service")},[s,a]),A=(0,o.useCallback)(e=>{var t;if((null==(t=c.current)?void 0:t.readyState)===WebSocket.OPEN)try{c.current.send(JSON.stringify({type:"reset",sessionId:e}))}catch(e){console.error("Failed to send reset message:",e),null==a||a("Failed to reset conversation")}u([])},[a]),L=(0,o.useCallback)(()=>{u([]),y.current.clear(),v.current=null},[]);return(0,o.useEffect)(()=>(n&&N(),()=>{w.current=!1,c.current&&(c.current.close(1e3,"Component unmounting"),c.current=null)}),[n]),(0,o.useEffect)(()=>()=>{w.current=!1,c.current&&c.current.close()},[]),{messages:l,status:d,isConnected:"open"===d,isConnecting:"connecting"===d,sendMessage:T,reset:A,clearMessages:L,connect:N,disconnect:W,setMessages:u,websocket:c.current}}},6588:(e,t,n)=>{n.d(t,{$0:()=>r,F1:()=>c,Kd:()=>s,L6:()=>a,Vy:()=>i,wb:()=>l});var o=n(7614);function r(e){let t=e||o.env.NEXT_PUBLIC_WS_URL||"ws://localhost:3001/ws";try{let e=new URL(t);"localhost"===e.hostname&&(e.hostname=window.location.hostname,t=e.toString())}catch(e){console.warn("Invalid WS URL:",t)}return t}async function s(){try{var e,t,n;let o=await fetch("/api/sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!o.ok)throw Error("Failed to create session");let r=await o.json();if(r.success&&(null==(t=r.data)||null==(e=t.session)?void 0:e.id))return r.data.session.id;if(null==(n=r.data)?void 0:n.sessionId)return r.data.sessionId;throw console.error("Unexpected session response format:",r),Error("Invalid session response format")}catch(e){return console.error("Error creating auto session:",e),"chat-".concat(Date.now())}}async function a(e){if(!(await fetch("/api/sessions/".concat(e,"/load"),{method:"POST",headers:{"Content-Type":"application/json"}})).ok)throw Error("Failed to load session on backend")}async function i(e){var t;let n=await fetch("/api/sessions/".concat(e,"/history"));if(!n.ok){if(404===n.status){if(!(await fetch("/api/sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e})})).ok)throw Error("Failed to create session");return[]}throw Error("Failed to load session history")}let o=await n.json();return(null==(t=o.data)?void 0:t.history)||o.history||[]}function c(e,t){let n=[];for(let o=0;o<e.length;o++){let r=e[o],s={id:"session-".concat(t,"-").concat(o),role:r.role,content:r.content,createdAt:Date.now()-(e.length-o)*1e3,sessionId:t};if("assistant"===r.role&&r.toolCalls&&r.toolCalls.length>0)r.content&&n.push(s),r.toolCalls.forEach((r,s)=>{var a;let i,c=r.function?JSON.parse(r.function.arguments||"{}"):{},l=(null==(a=r.function)?void 0:a.name)||"unknown";for(let t=o+1;t<e.length;t++){let n=e[t];if("tool"===n.role&&n.toolCallId===r.id){i=n.content;break}}n.push({id:"session-".concat(t,"-").concat(o,"-tool-").concat(s),role:"tool",content:null,createdAt:Date.now()-(e.length-o)*1e3+s,sessionId:t,toolName:l,toolArgs:c,toolResult:i})});else{if("tool"===r.role)continue;n.push(s)}}return n}async function l(){try{await fetch("/api/sessions/null/load",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(e){console.warn("Error resetting backend session:",e)}}o.env.NEXT_PUBLIC_API_URL},6728:(e,t,n)=>{n.d(t,{ChatProvider:()=>c,vd:()=>l});var o=n(4684),r=n(4464),s=n(6036),a=n(6588);let i=(0,r.createContext)(null);function c(e){let{children:t,wsUrl:n,autoConnect:c=!0}=e,l=(0,a.$0)(n),[u,d]=(0,r.useState)(null),[h,f]=(0,r.useState)(!0),[w,p]=(0,r.useState)(!0),{messages:g,sendMessage:m,status:y,reset:v,setMessages:b,websocket:k,clearMessages:C}=(0,s.Y)(l,{autoConnect:c,onMessage:e=>{window.dispatchEvent(new CustomEvent("cipher:newMessage",{detail:{message:e,sessionId:u}}))},onError:e=>{console.error("Chat WebSocket error:",e),window.dispatchEvent(new CustomEvent("cipher:error",{detail:{error:e,sessionId:u}}))},onStatusChange:e=>{console.log("Chat WebSocket status changed:",e),window.dispatchEvent(new CustomEvent("cipher:statusChange",{detail:{status:e,sessionId:u}}))}}),E=(0,r.useCallback)(async(e,t,n)=>{let o=u;if(!o&&h)try{o=await (0,a.Kd)(),await (0,a.L6)(o),d(o),f(!1)}catch(e){throw console.error("Error creating auto session:",e),e}if(o)m(e,t,n,o,w);else throw console.error("No session available for sending message"),Error("No session available for sending message")},[m,u,h,w]),S=(0,r.useCallback)(async e=>{try{let t=await (0,a.Vy)(e),n=(0,a.F1)(t,e);b(n)}catch(e){console.error("Error loading session history:",e),b([])}},[b]),I=(0,r.useCallback)(async e=>{if(e!==u)try{await (0,a.L6)(e),d(e),f(!1),await S(e),window.dispatchEvent(new CustomEvent("cipher:sessionChanged",{detail:{sessionId:e,previousSessionId:u}}))}catch(e){throw console.error("Error switching session:",e),e}},[u,S]),N=(0,r.useCallback)(()=>{d(null),f(!0),C(),(0,a.wb)(),window.dispatchEvent(new CustomEvent("cipher:returnToWelcome",{detail:{previousSessionId:u}}))},[u,C]),W=(0,r.useCallback)(()=>{u&&(v(u),window.dispatchEvent(new CustomEvent("cipher:conversationReset",{detail:{sessionId:u}})))},[v,u]),T=(0,r.useCallback)(e=>{p(e),window.dispatchEvent(new CustomEvent("cipher:streamingChanged",{detail:{streaming:e,sessionId:u}}))},[u]);return(0,r.useEffect)(()=>{let e=e=>{console.log("Config changed:",e.detail)},t=e=>{console.log("Servers changed:",e.detail)},n=e=>{let{sessionId:t}=e.detail||{};t===u&&b([])},o=e=>{let{sessionId:t}=e.detail||{};t&&t!==u&&I(t).catch(e=>{console.error("Error handling external session switch:",e)})},r=e=>{N()};return window.addEventListener("cipher:configChanged",e),window.addEventListener("cipher:serversChanged",t),window.addEventListener("cipher:conversationReset",n),window.addEventListener("cipher:switchSession",o),window.addEventListener("cipher:requestWelcome",r),()=>{window.removeEventListener("cipher:configChanged",e),window.removeEventListener("cipher:serversChanged",t),window.removeEventListener("cipher:conversationReset",n),window.removeEventListener("cipher:switchSession",o),window.removeEventListener("cipher:requestWelcome",r)}},[u,b,I,N]),(0,r.useCallback)(async()=>{try{let e=await (0,a.Kd)();return await (0,a.L6)(e),e}catch(e){throw console.error("Error creating new session:",e),e}},[]),(0,o.jsx)(i.Provider,{value:{messages:g,sendMessage:E,status:y,reset:W,currentSessionId:u,switchSession:I,loadSessionHistory:S,isWelcomeState:h,returnToWelcome:N,isStreaming:w,setStreaming:T,websocket:k},children:t})}function l(){let e=(0,r.useContext)(i);if(!e)throw Error("useChatContext must be used within a ChatProvider");return e}}}]);